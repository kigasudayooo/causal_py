## 統計的因果推論の基礎概念整理

## まとめたいもの

- https://note.com/k_three/n/nf86b44743c2f
- Hayashi20monozukuri_v20201218.pdf
- https://elsur.jpn.org/mt/2012/08/001611.html
- https://yhiss.hatenablog.com/entry/2020/04/12/170309
- https://takehiko-i-hayashi.hatenablog.com/entry/2014/07/09/015442
- https://jtsutsui.hatenablog.com/entry/20130830/1377854965

:::info
そもそものモチベーション
- 母集団における関心のある未知のパラメータ（Estimand）を知るために、ある手法(Estimator)を使って値を推計(Estimate)する。

用語
- アウトカム（=Endpoint = Dependent Variable）
- 暴露因子(=Exposure = Treatment = Explanatory Variable)
- 共変量(=Covariaes = Adjustment Variables)
:::

### 反実仮想(Counterfactual)について
ある２人A(介入あり),B(介入なし)についてみれば、結果を観測できるのは以下の値のみ。
| 　| $T=0$ | $T=1$ |
|--|--|--|
|$Y_A$ | × | 〇|
|$Y_B$ | 〇 | ×|

個人の効果を定式化すると、$Y^{T=1} - Y^{T=0}$が本来知りたいと直感的に思われるが、これは同時に観測できない(上表の通り)。

　この時、平均的にはどの程度の効果が見込めるのかという問いに落とし込んだ際の定式化は、$E[Y^{T=1}] - E[Y^{T=0}]$であり、これは関心のある母集団”全体”が介入を受けた時と、”全体”が介入を受なかった時の差(=**平均処置効果(Average Treatment Effect)**)。
　当然全体が介入を受ける場合と受けない場合を同時に観測することはできないので、これを計算するためには仮定が必要。直観的には$E[Y^{T=1}|T=1] = E[Y^{T=1}|T=0]$のように、介入を受けた群と受けなかった群で、介入がもしあった場合の結果は同じ、というような条件が必要そうだなと感じると思う。


## 必要な仮定([参考文献](https://www.krsk-phs.com/entry/counterfactual_assumptions))

:::info
1. (Mean) Exchangeability
- $E[Y^{T=1}|T=1] = E[Y^{T=1}|T=0]$のように、介入を受けた群と受けなかった群で、介入がもしあった場合の結果は同じ(介入がなかった場合も同様)。

  * 具体例としては、教育訓練の有無が収入に与える関係を考えた時に、自然な状況(個人が訓練の受講を自由に決められる状況)では、教育に対して熱心な者(人的資本形成への関心が強く、訓練の受講以外でも収入を伸ばしやすい)と熱心でない者では、受講以外の要因も影響しそう。これは、**交換可能性がない**状況。
    - より丁寧に言えば、個人の熱心度という要素が**交絡項**になっている。交絡項は分析の段階で調整しないと適切な推論ができない。
    - 教育訓練の受講に効くものの、ほかの要因には影響しない変数(たとえばある地域限定の教育訓練給付とか)は無視してもよい。
    - 詳しくはバックドア基準などDAG(有向非循環グラフ)を調べるとよい([参考](https://www.krsk-phs.com/entry/DAG1))。
    ```mermaid
    graph TD;
    
    地域限定の教育訓練給付-->教育訓練受講;
    熱心度-->教育訓練受講;
    熱心度-->訓練受講以外での自主的な勉強等;
    
    
    
    教育訓練受講-->年収増加;
    訓練受講以外での自主的な勉強等-->年収増加;
    
    ```
  * 上記の場合、訓練の受講が例えばくじ引きでランダムに決まるのであれば、訓練の有無は個人の性質(上記の例では熱心度)から独立になるので、交換可能性が担保される。
  * ランダムでない場合は、（この場合では）熱心度をコントロールすることで分析する。これがConditional Exchangeability。$$E[Y^{T=1}|T=1,熱心度] = E[Y^{T=1}|T=0,熱心度]$$
  * なお、より強い条件として、介入の有無(T)と効果(Y)がすべての介入について独立であることを要請する、Full Exchangeabilityがあるが基本的には考えなくてよい。

- 実際に訓練を割り当てられても、さぼったりする者がいるために正しい効果がわからない場合がある(割付に従わない、non-complierの存在)。
- また、そもそも介入の内容が同質でない可能性(講師の技術の高低など)があることにも留意することが必要。

2. Consistency
- ある介入を受けた者の結果は、その介入を受けた者が仮に介入を受けたと仮定したときにとりうる結果に等しい。(←???)
　数式で書くと、
 $$\forall i,\ T_i=1 \ \ then \ \  Y_{i,T=1}=Y_i$$であり、集団でみれば、 $$E[Y_{T=1}|T=1]\ = \ E[Y|T=1]$$が成り立つ。
 
- あたり前な気もするが、実際の結果$Y$の原因が、先ほどの例でいえば訓練の内容が様々で、そのうち特定の訓練が効いているのであれば、consistencyは担保されない。
    ```mermaid
    graph TD;
  
    
    教育訓練の受講に関する介入-->教育訓練を受講;
    
    教育訓練を受講-->訓練を毎日受講;
    教育訓練を受講-->訓練を月一回受講;
    
    
    訓練を毎日受講-->年収増加;
    訓練を月一回受講-.->|受講した事実はあれど効果の有無は不明|年収増加;
    
    ```
- このような場合は、Multiple Version of Treatmentと呼び、$Y_{T=1}$が一意に定義されない。
  * トリートメントがしっかりと意味のある水準まで(例えば何時に訓練を受けるかはあまり影響なさそう)限定されている必要がある。
  * ちなみに、上の条件(sufficientry well-defined intervention)をクリアしたうえで、その評価がきちんと行えるかという、*Linkage with Observed Data*という条件もある。

3. Positivity
- どちらのトリートメントも観測される可能性が0ではない。
- そもそも両方の観測値がなければ比較できないので、当たり前だと思われがちだが、Conditionalにしたときに成り立つかは丁寧に考える必要がある。

4. Other assumptions
- Measurement error / Misclassification

- Model Specification

- Selection Bias

:::

:::info
## SUTVA
- Counterfactualアプローチのためには、以下の二つの仮定が必要
1. No Interference between units
- 他の人が介入を受けたかによって、自分の結果が変わらない。
  * 例えば感染症のワクチンは、ほかの人が摂取していれば自分の感染確率が下がるので、アウトカムが変わりうる。
  
2. No versions of treatments
- みんな介入の内容が同じ
  * 医者の手術の腕や、投与される薬の内容など…。

:::